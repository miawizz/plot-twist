<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plot Twist — Story Builder</title>
  <meta name="theme-color" content="#1b3c4b" />
  <link rel="manifest" href="manifest-v2.json">

  <!-- Social share preview -->
  <meta property="og:image" content="https://miawizz.github.io/plot-twist/plot-twist-logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="1200" />
  <meta property="og:title" content="Plot Twist — Story Builder" />
  <meta property="og:description" content="A fun, creative storytelling game for kids and families. Tap for titles, plot twists, and ways to wrap it up!" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
:root {
  --bg: #fdf3de;
  --ink: #213547;
  --brand: #eb6e52;
  --brand-dark: #ea694d;
  --muted: #5a6b75;
  --card: #ffffff;
  --accent: #fef7e3;
  --radius: 18px;
  --shadow: 0 6px 24px rgba(0,0,0,.08);
}

* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--ink);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
.container { max-width: 960px; margin: 0 auto; padding: 20px 16px 64px; }
header { display: grid; gap: 8px; justify-items: center; margin: 8px 0 16px; text-align: center; }
.logo { height: 70px; width: auto; }
.instructions { background: var(--card); padding: 18px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: left; }
.instructions h2 { margin-top: 0; color: var(--brand-dark); }
.grid { display: grid; gap: 16px; margin-top: 20px; }
@media (min-width: 860px){ .grid { grid-template-columns: 1fr 1fr; } }
@media (min-width: 1100px){ .grid { grid-template-columns: 1fr 1fr 1fr; } }
.card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px; }
.card h2 { margin: 0 0 10px; font-size: 16px; color: var(--brand-dark); }
.out { background: #fff; border: 2px dashed #d7e3e8; border-radius: var(--radius); padding: 14px; min-height: 60px; display: flex; align-items: center; font-weight: 600; }
.btns { display: flex; gap: 10px; flex-wrap: wrap; }
button { appearance: none; border: 0; padding: 12px 14px; border-radius: 14px; font-weight: 700; cursor: pointer; background: var(--brand); color: #fff; box-shadow: 0 4px 14px rgba(0,0,0,.08); letter-spacing: .2px; }
button.secondary { background: #edf6f9; color: var(--brand-dark); font-weight: 600; }
.muted { color: var(--muted); font-size: 13px; }
footer { text-align:center; font-size:12px; color:#666; margin: 24px 0 40px; padding: 0 16px; }

/* Password overlay */
#gateOverlay {
  position: fixed; inset: 0; background: rgba(253,243,222,0.97);
  backdrop-filter: blur(2px);
  display: grid; place-items: center;
  z-index: 9999; opacity: 1; transition: opacity .35s ease;
}
#gateCard {
  width: min(560px, 92%); background: var(--card); border-radius: 20px; box-shadow: var(--shadow);
  padding: 22px; text-align: left;
}
#gateCard h2 { margin: 0 0 8px; color: var(--brand-dark); font-size: 20px; }
#gateCard p { margin: 6px 0; color: var(--muted); }
#gateForm { display:flex; gap:10px; align-items:center; margin-top:12px; }
#gateInput {
  flex:1; padding:12px 14px; border:2px dashed #d7e3e8; border-radius:14px; font-weight:600;
}
#gateEnter { background: var(--brand); color:#fff; border:0; padding:12px 14px; border-radius:14px; font-weight:700; cursor:pointer; }
#gateMsg { margin-top:8px; color:#ea694d; font-size:13px; }
.hideGate { opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
  <!-- Password overlay (case-insensitive, no hint) -->
  <section id="gateOverlay" role="dialog" aria-labelledby="gateTitle" aria-modal="true">
    <div id="gateCard">
      <h2 id="gateTitle">Private access</h2>
      <p>This app is only for those who have purchased from <strong>Playful Heart Parenting</strong>. Please enter the password from your receipt.</p>
      <form id="gateForm">
        <input id="gateInput" type="password" autocomplete="current-password" placeholder="Enter password" />
        <button id="gateEnter" type="submit">Enter</button>
      </form>
      <div id="gateMsg" aria-live="polite"></div>
    </div>
  </section>

  <div class="container" id="appRoot">
    <header>
      <img src="plot-twist-logo.png" alt="Plot Twist logo" class="logo" />
    </header>

    <div class="instructions">
      <h2>Here's How to Play Plot Twist!</h2>
      <p>Work together to make up a silly, creative, imaginative story by taking turns every few sentences.</p>
      <h3>Tips for Taking Turns</h3>
      <ul>
        <li>Use a "story stick" — any item around the house like a toy or even a spoon. Whoever holds the story stick gets to speak, then passes it to the next person.</li>
        <li>Or try saying "Popcorn!" and pointing to whoever's turn it is next to "pop" the story over to them.</li>
        <li>If playing with more than two people, establish the order before you start playing.</li>
      </ul>
      <p>Whenever you need a little creative inspiration to move the story along or just want to shake things up,<br><br>
      say "PLOT TWIST!" and tap the button for an idea!<br><br>
      You can tap as many times as you want... but...<br><br>
      For a fun challenge, do your best to stick with whatever idea is given to you and find a creative way to work it into the story — even if it doesn't seem to make sense at first.<br><br>
      Happy storytelling!</p>
    </div>

    <section class="card" aria-labelledby="recHeading" style="margin-top:16px">
      <h2 id="recHeading">Record Your Story!</h2>
      <div class="out" id="recStatus" aria-live="polite">Ready to record. Your audio stays on your device.</div>
      <div class="btns" style="margin-top:10px">
        <button id="btnRecStart">Start recording</button>
        <button class="secondary" id="btnRecStop" disabled>Stop</button>
        <button class="secondary" id="btnRecPlay" disabled>Play</button>
        <button class="secondary" id="btnRecDownload" disabled>Download MP3</button>
      </div>
      <p class="muted" id="mp3Note" style="display:none;">Encoding MP3…</p>
      <audio id="player" controls style="width:100%; margin-top:10px; display:none"></audio>
    </section>

    <div class="grid">
      <section class="card" aria-labelledby="titleHeading">
        <h2 id="titleHeading">STORY TITLE...</h2>
        <div class="out" id="titleOut" aria-live="polite">Tap the button below to get a title</div>
        <div class="btns" style="margin-top:10px">
          <button id="btnTitle">GET A TITLE!</button>
          <button class="secondary" id="btnReset">Reset</button>
        </div>
        <p class="muted">Here's a title suggestion to inspire the beginning of your story. Need a way to start? Try "Once Upon a Time..." or "Long ago and far away, there lived a..." — you can’t go wrong with the classics.</p>
      </section>

      <section class="card" aria-labelledby="twistHeading">
        <h2 id="twistHeading">READY FOR A PLOT TWIST..?</h2>
        <div class="out" id="twistOut" aria-live="polite">Tap the button below for a new idea</div>
        <div class="btns" style="margin-top:10px">
          <button id="btnTwist">PLOT TWIST!</button>
        </div>
        <p class="muted">Tap the Plot Twist button any time you want some inspiration!</p>
      </section>

      <section class="card" aria-labelledby="wrapHeading">
        <h2 id="wrapHeading">READY TO WRAP IT UP...?</h2>
        <div class="out" id="wrapOut" aria-live="polite">Tap the button below for a tip on how to end your story</div>
        <div class="btns" style="margin-top:10px">
          <button class="secondary" id="btnWrap">IDEAS FOR HOW TO END...</button>
        </div>
        <p class="muted">Need a little nudge for how to wrap up? Tap for a general idea and find a way to end the story together!</p>
      </section>
    </div>
  </div>

  <footer>
    © 2025 Mia Wisinski, Playful Heart Parenting. This app is for personal use only by those who have purchased access from Playful Heart Parenting. Please do not share this link publicly or distribute without explicit permission.
  </footer>

  <!-- lamejs MP3 encoder -->
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>

  <script>
/* ===================
   Password overlay (case-insensitive)
=================== */
const PASSWORD = "pt";
const gateOverlay = document.getElementById('gateOverlay');
const gateForm = document.getElementById('gateForm');
const gateInput = document.getElementById('gateInput');
const gateMsg = document.getElementById('gateMsg');

function unlockGate(){
  gateOverlay.classList.add('hideGate');
  setTimeout(()=>{ gateOverlay.style.display='none'; }, 350);
  sessionStorage.setItem("plotTwist_access","yes");
}
(function initGate(){
  if (sessionStorage.getItem("plotTwist_access")==="yes") {
    gateOverlay.style.display='none';
  } else {
    gateOverlay.style.display='grid';
    gateInput.focus();
  }
})();
gateForm.addEventListener('submit',(e)=>{
  e.preventDefault();
  const val=(gateInput.value||'').trim().toLowerCase();
  if (val===PASSWORD.toLowerCase()) { gateMsg.textContent=''; unlockGate(); }
  else { gateMsg.textContent="That password doesn’t look right. Please check your receipt and try again."; gateInput.select(); }
});

/* ===================
   Prompt data
=================== */
const TITLES = [
  "The chipmunk who accidentally ate all the acorns in the forest",
  "The magical trash can",
  "Sally, the pig who wanted to be a singer",
  "Humphrey the invisible humpback whale",
  "The summer Henrietta discovered grilled cheese sandwiches",
  "The alligator’s mysterious trip to the dentist",
  "Darleen the dinosaur who couldn’t roar",
  "Two best friends and a time machine",
  "The little car who could only drive 5 miles per hour",
  "Thirteen ducks and a goose named Gary",
  "Wilbur the astronaut worm",
  "Gilbert the goat who couldn’t stop eating socks",
  "The giant who got the hiccups",
  "The magical talking pancake",
  "The day it rained ramen noodles",
  "Princess Penelope and the very stinky fart",
  "The day my pickle sandwich came to life",
  "The secret snack society",
  "The baby dragon who was scared of fire",
  "Thomas the turtle who started a rock band",
  "Gertrude the goose and her bad habit",
  "The magical couch",
  "Stanley the snail who wanted to go fast",
  "The legend of the purple cheeseburger",
  "The potato who wanted to have his own TV show",
  "The lost booger",
  "Lucinda the lion’s very fancy birthday party",
  "The chicken who was allergic to bawking",
  "The unicorn and octopus who became best friends",
  "The piece of cheese who tried to escape from the fridge",
  "Belinda the ballerina baboon",
  "The magical remote control",
  "The very confused penguin",
  "Grandma Gertie’s magical nose hair",
  "Tiny the T-Rex who opened a nail salon",
  "Robby the robot who fell in love",
  "The itsy bitsy spider’s big adventure to the zoo",
  "Mabel the mouse who wanted to get a pet donkey",
  "The mysterious lemonade stand",
  "The very silly cat sisters",
  "Bob and his cheese sculptures",
  "The day Dad turned into a donut",
  "Zeke the zebra who didn’t like his stripes",
  "The frog clown",
  "The disappearing gingerbread house",
  "The time machine powered by farts",
  "The very lazy mermaid",
  "The case of the stinky socks",
  "The hamster who could read people’s minds",
  "The very lonely elephant",
  "The shoes who wanted a day off",
  "The panda who ate too much bamboo",
  "The very rude pigeon",
  "The wizard who couldn’t stop burping",
  "The little chicken who never gave up",
  "Barrelda the pig who learned her manners",
  "The very confusing birthday party",
  "The case of the missing ice cream sandwiches",
  "Four squirrels and their sailboat",
  "The great big terrible fart",
  "The burp who wanted to make a friend",
  "The very silly cupcake baker",
  "The mystery of the disappearing library",
  "Geoffrey the giraffe who had a short neck",
  "Eggarina, the hard-boiled egg who wanted to be a pop star",
  "The blueberry who fell in love with a strawberry",
  "The fart heard ‘round the world",
  "The very shy pumpkin"
];

const TWISTS = [
  "Suddenly, a wizard appeared and said, “I’ll turn everyone into a pumpkin if you don’t do what I say!”",
  "Suddenly, a mysterious map floated down from the sky.",
  "Just then, a troll popped out and yelled, “I’m late!”",
  "Then, they heard a loud growl coming from around the corner…",
  "Suddenly, they noticed a tiny door… and it was open.",
  "Just then, a mysterious voice whispered, “There’s treasure hidden near you, all you have to do is follow these clues...”",
  "Just then, a nice old man wandered over and asked for a sandwich.",
  "Suddenly, they heard a loud, “BAWK!” and a giant chicken was heading straight toward them…",
  "Suddenly, they sneezed so big that they started lifting off the ground…!",
  "Just then, a weird stinky smell started to waft through the air and they immediately knew what it was…",
  "But nobody noticed the slippery banana peel lying right in front of them on the ground.",
  "Just then, they heard a loud bark and turned around to see a giant Great Dane drooling all over their stuff.",
  "Suddenly, a mysterious letter started floating down from the sky. It said…",
  "Just then, it started raining extremely hard, but it wasn’t normal rain…",
  "Something then caught their eye in the corner. It was a shiny gold coin…",
  "Suddenly, it started to smell like the yummiest waffles in the world.",
  "Just then, a loud boom could be heard throughout the land.",
  "Just then, the phone started ringing and a voice on the other line started trying to order some pizza.",
  "Suddenly, a dragon flew in and asked for directions to the dragon dance.",
  "Just then, a duck on a skateboard rolled past yelling, “NO TIME TO EXPLAIN, hop on!!”",
  "Just then, they heard a loud crash!",
  "It suddenly started to snow, to everyone’s surprise, so they all decided to…",
  "Nobody saw the little troll sneaking up behind them trying to steal all their snacks.",
  "Suddenly, a big large shadow appeared.",
  "Just then, a marching band burst in and played “Happy Birthday”—whose birthday was it?",
  "Before anyone even realized it, they looked down to see that their feet were dancing all by themselves!",
  "Then, out of the blue, a great owl swept down and said, “I have a warning for you…”",
  "Just then, there was a big “poof!” and out of a cloud of sprinkles and glitter, a fairy appeared…",
  "Suddenly, a loud fart, loud as thunder, rumbled through the land!",
  "Just then, the skies opened up and it started raining sprinkles!",
  "Just then, the skies opened up and it started raining pizza.",
  "Then, they could not believe their eyes… it started snowing, but it wasn’t snow. It was marshmallows!",
  "Just then, a little squeaky voice spoke up from the corner. It was a mouse who had been watching everything and had something to say…",
  "Suddenly, a little old lady named Griselda waddled in and yelled, “Who’s been stealing my petunias?!?”",
  "Just then, they heard a cackle and looked up to see a silly witch flying by on a broomstick… but when they looked closer it wasn’t actually a witch! It was a…",
  "“ROARRR!” roared a voice that startled everyone. It was the monster who lived in the next village over…",
  "Suddenly, music started blasting loudly out of nowhere. It was the song “John Jacob Jingleheimer Schmidt!” Everyone was very confused…",
  "Just then, a mysterious voice said, “I have the answer to all your problems. Just follow me!”",
  "Suddenly, a genie popped out and said, “Congratulations! You’ve just said the magic word and have now unlocked three wishes! What’s your first wish?!”",
  "Just then, an ice cream truck started driving by and everyone screamed…",
  "All of a sudden, the ground started to move beneath them… and they realized they had been standing on a giant this whole time!!",
  "Just then, they looked up to see a shooting star, but not just any shooting star. This one was extra sparkly and bright. They decided to make a wish…",
  "Suddenly, a giant grumpy toad bounced into the room and croaked, “Follow me if you know what’s good for ya!”",
  "Just then, a voice came from a nearby peanut butter jar whimpering, “Let me out!! I’ve been trapped for days…”",
  "Suddenly, the lights flickered… and out of nowhere appeared a magician! “Welcome to my show!” he cheered…",
  "Just then, a chihuahua wearing a tiny tuxedo burst through the door barking wildly.",
  "Suddenly, a gust of wind blew open the window, and a swarm of butterflies flew in.",
  "Just then, they realized something… They were all shrinking. Either that… or everything around them was growing bigger and bigger…",
  "Just then, a mysterious stranger walked over and offered them a rubber chicken, saying, “You look like you needed this…”",
  "“Meowww,” said the cat that was suddenly walking around from the corner. “Got any cat food? I’m hungry!”",
  "Suddenly, the ceiling began to shake and they realized there were 20 big raccoons jumping on the roof!",
  "Just then, a little robot zoomed in and beeped, “Greetings. I am Zog two point oh. At your service!”",
  "Just then, a tiny kazoo sound echoed through the air… who was playing it?",
  "Suddenly, a taxi cab pulled up and said, “Did somebody call for a ride?”",
  "Just then, they noticed a mysterious box in the corner that began shaking… and growling!",
  "Suddenly, the sky turned bright pink and it started raining candy.",
  "Just then, they tripped over a shoe that someone had left lying in the middle of the floor…",
  "Suddenly, a bubble appeared and started floating toward them, getting bigger and bigger until suddenly…",
  "Just then, someone shouted, “Oh my goodness, it’s Queen Dingledongle!” And sure enough, when they turned around, the Queen herself was approaching them.",
  "Suddenly, a gold, shimmery circle appeared in the middle of the air. It was a portal to another world!",
  "Just then, the ground beneath them rumbled and they realized that a nearby volcano was about to erupt!",
  "Just then, they looked up and noticed that all the clouds in the sky were mysteriously shaped like beagles. “What could it mean??” they wondered…",
  "Just then, the door creaked open and revealed… a very tall, very grumpy lady named Barthalia.",
  "“Hey!” shouted a voice out of the blue, “This would be the perfect spot to open up my new theme park!”",
  "Just then, a slowww parade of snails began slithering by… complete with a tiny snail marching band, tiny flags, and tiny snail floats.",
  "Suddenly, they heard a voice yelling, “Charge!” and looked up to see a great big angry donkey running straight toward them.",
  "Just then, a whistle blew from behind them. “That’s enough of that!” said the football coach who they hadn’t realized was there. “It’s time to play some football!”",
  "Suddenly, a loud voice shrieked, “Get back here, Matilda!!” and they turned to see a farmer chasing his cow Matilda, who was running away.",
  "Suddenly, a voice yelled, “LOOK OUT BELOW!!” and they looked up to see a funny‑looking little man wearing goggles in a parachute floating down from the sky right above them.",
  "Suddenly, a loud grumbling sound started getting louder and louder… it sounded like a hungry tummy…",
  "Just then, a very strange smell started wafting through the air. It smelled like rotten eggs…",
  "Just then, a delicious smell started filling the air… it smelled like someone was baking pie!",
  "Suddenly, confetti started pouring down and a small crowd of people popped out yelling, “Surprise!!”",
  "All of a sudden, a faint crying sound was coming from nearby…",
  "Just then, a wandering moose appeared, looking lost and confused.",
  "Just then, a gust of glitter blew through the air and the sound of a tiny, mischievous laugh became louder and louder…",
  "Suddenly, a loud honk echoed through the air, and a very rude goose waddled over.",
  "Just then, it began raining purple… “Wait a second… is that grape juice??” they said.",
  "Suddenly, they heard the sound of a kazoo… getting louder… and louder…",
  "Just then, all the clocks started spinning backwards and they realized they were somehow traveling back in time.",
  "Suddenly, a sweet little old lady rode up on a scooter yelling, “The muffins are ready! Who wants one?!”",
  "Just then, they got a strange feeling that something stinky was about to happen…",
  "“Whoa, do I know you? You look so familiar!!” said a friendly voice out of nowhere.",
  "Suddenly, a thunderous BURP erupted… it was the loudest burp anyone has ever heard…"
];

const WRAP_HINTS = [
  "End the story with something happy",
  "Finish by solving the main problem",
  "Have the characters feel safe again",
  "Let everyone get what they were hoping for",
  "Show how things have changed since the beginning",
  "End with the characters making a plan for next time",
  "Wrap it up with a feeling — excitement, relief, joy, or calm",
  "Leave the story open so it could continue later",
  "End in the same place or situation where it began",
  "Give the final line to the main character"
];

/* ===================
   DOM + helpers
=================== */
const titleOut=document.getElementById('titleOut');
const twistOut=document.getElementById('twistOut');
const wrapOut=document.getElementById('wrapOut');
const btnTitle=document.getElementById('btnTitle');
const btnTwist=document.getElementById('btnTwist');
const btnWrap=document.getElementById('btnWrap');
const btnReset=document.getElementById('btnReset');

const recStart=document.getElementById('btnRecStart');
const recStop=document.getElementById('btnRecStop');
const recPlay=document.getElementById('btnRecPlay');
const recDl=document.getElementById('btnRecDownload');
const recStatus=document.getElementById('recStatus');
const player=document.getElementById('player');
const mp3Note=document.getElementById('mp3Note');

const pick=arr=>arr[Math.floor(Math.random()*arr.length)];

/* ===================
   Generators
=================== */
btnTitle.addEventListener('click',()=>{
  titleOut.textContent=pick(TITLES)||'A brand new story';
  twistOut.textContent='Tap the button below for a new idea';
  wrapOut.textContent='Tap the button below for a tip on how to end your story';
});
btnTwist.addEventListener('click',()=>{ twistOut.textContent=pick(TWISTS)||'Something unexpected happened'; });
btnWrap.addEventListener('click',()=>{ wrapOut.textContent=pick(WRAP_HINTS)||'Finish in a simple, happy way'; });
btnReset.addEventListener('click',()=>{
  titleOut.textContent='Tap the button below to get a title';
  twistOut.textContent='Tap the button below for a new idea';
  wrapOut.textContent='Tap the button below for a tip on how to end your story';
});

/* ===================
   Recorder (Web Audio + lamejs MP3)
=================== */
let audioCtx=null, mediaStream=null, sourceNode=null, processor=null;
let leftBuffers=[], rightBuffers=[], recordingLength=0, mp3Blob=null;

function isiOS() {
  return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

function mergeFloat32(buffers, totalLen){
  const out = new Float32Array(totalLen);
  let offset = 0;
  for(const b of buffers){ out.set
