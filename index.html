<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plot Twist — Story Builder</title>
  <meta name="theme-color" content="#1b3c4b" />
  <link rel="manifest" href="manifest-v2.json">

  <!-- Social share preview -->
  <meta property="og:image" content="https://miawizz.github.io/plot-twist/plot-twist-logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="1200" />
  <meta property="og:title" content="Plot Twist — Story Builder" />
  <meta property="og:description" content="A fun, creative storytelling game for kids and families. Tap for titles, plot twists, and ways to wrap it up!" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
:root {
  --bg: #fdf3de;
  --ink: #213547;
  --brand: #eb6e52;
  --brand-dark: #ea694d;
  --muted: #5a6b75;
  --card: #ffffff;
  --accent: #fef7e3;
  --radius: 18px;
  --shadow: 0 6px 24px rgba(0,0,0,.08);
}

* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--ink);
  line-height: 1.5;
}
.container { max-width: 960px; margin: 0 auto; padding: 20px 16px 64px; }
header { display: grid; gap: 8px; justify-items: center; margin: 8px 0 16px; text-align: center; }
.logo { height: 70px; width: auto; }
.instructions { background: var(--card); padding: 18px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: left; }
.instructions h2 { margin-top: 0; color: var(--brand-dark); }
.grid { display: grid; gap: 16px; margin-top: 20px; }
@media (min-width: 860px){ .grid { grid-template-columns: 1fr 1fr; } }
@media (min-width: 1100px){ .grid { grid-template-columns: 1fr 1fr 1fr; } }
.card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px; }
.card h2 { margin: 0 0 10px; font-size: 16px; color: var(--brand-dark); }
.out { background: #fff; border: 2px dashed #d7e3e8; border-radius: var(--radius); padding: 14px; min-height: 60px; display: flex; align-items: center; font-weight: 600; }
.btns { display: flex; gap: 10px; flex-wrap: wrap; }
button { appearance: none; border: 0; padding: 12px 14px; border-radius: 14px; font-weight: 700; cursor: pointer; background: var(--brand); color: #fff; box-shadow: 0 4px 14px rgba(0,0,0,.08); letter-spacing: .2px; }
button.secondary { background: #edf6f9; color: var(--brand-dark); font-weight: 600; }
.muted { color: var(--muted); font-size: 13px; }
footer { text-align:center; font-size:12px; color:#666; margin: 24px 0 40px; padding: 0 16px; }

/* One-time courtesy overlay */
#courtesyOverlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.4);
  display: none; place-items: center;
  z-index: 9999; opacity: 1; transition: opacity .3s ease;
}
.courtesy-card {
  width: min(560px, 92%);
  background: var(--card);
  color: var(--ink);
  border-radius: 18px;
  box-shadow: 0 12px 40px rgba(0,0,0,.18);
  padding: 22px;
  text-align: left;
}
.courtesy-card h2 { margin: 0 0 8px; color: var(--brand-dark); font-size: 20px; }
.courtesy-card p { margin: 6px 0 14px; color: var(--muted); }
.courtesy-check { display:flex; align-items:center; gap:10px; margin: 6px 0 12px; }
#courtesyContinue {
  width: 100%; padding: 12px 14px; border: 0;
  border-radius: 14px; font-weight: 700; cursor: pointer;
  background: var(--brand); color: #fff;
  box-shadow: 0 4px 14px rgba(0,0,0,.08);
}
#courtesyContinue:disabled { opacity: .5; cursor: not-allowed; }
.courtesy-hide { opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
  <!-- Place this snippet right after <body> in each app -->
<style>
  /* Minimal, brand‑agnostic styling */
  .install-help {position:sticky;top:0;z-index:10001;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .install-help__wrap{background:#fff7f4;border-bottom:1px solid #f2e7e3}
  .install-help__summary{display:flex;align-items:center;gap:.5rem;padding:.55rem .85rem;cursor:pointer;font-size:.95rem}
  .install-help__summary:hover{background:#fff3ee}
  .install-help__summary .caret{transition:transform .2s ease}
  details[open] .install-help__summary .caret{transform:rotate(180deg)}
  /* Slight visual cue when open */
  details[open] .install-help__wrap{box-shadow:inset 0 -1px 0 #e7d8d3,0 1px 0 #e7d8d3}
  .install-help__panel{padding:.75rem .9rem .95rem .9rem;display:grid;gap:.75rem}
  .install-help__panel h4{margin:.25rem 0 .25rem 0;font-size:.95rem}
  .install-help__panel p{margin:0 0 .35rem 0;font-size:.9rem}
  .install-help__close{margin-left:auto;border:0;background:transparent;font:inherit;cursor:pointer;opacity:.7}
  .install-help__tips{font-size:.85rem;opacity:.9}
  .install-help__box{border:1px solid #efdfda;background:#fff;border-radius:.65rem;padding:.65rem .75rem}
  .install-help__steps{margin:.25rem 0 0 1.15rem}
  .install-help__steps li{margin:.25rem 0}
  .install-help__never{align-self:start;border:0;background:transparent;padding:0;font:inherit;color:#6b7f88;text-decoration:underline;cursor:pointer}
  .install-help__never:hover{color:#46565f}
  .hidden{display:none}
  @media (prefers-reduced-motion: reduce){.install-help__summary .caret{transition:none}}
</style>

<details class="install-help" id="install-help" data-dismiss-key="ph-install-help-lm">
  <summary class="install-help__wrap">
    <div class="install-help__summary" role="button" aria-expanded="false">
      <svg class="caret" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5z"></path></svg>
      <strong>Tap here for a reminder of how to save this app to your home screen</strong>
      <button class="install-help__close" type="button" title="Hide">✕</button>
    </div>
  </summary>
  <div class="install-help__panel" id="install-help-panel" aria-live="polite">
    <div class="install-help__box" id="ios-safari" hidden>
      <h4>iPhone or iPad using Safari</h4>
      <ol class="install-help__steps">
        <li>Tap the Share icon at the bottom of Safari</li>
        <li>Choose <em>Add to Home Screen</em></li>
        <li>Tap <em>Add</em></li>
      </ol>
    </div>

    <div class="install-help__box" id="ios-chrome" hidden>
      <h4>iPhone or iPad using Chrome</h4>
      <ol class="install-help__steps">
        <li>Tap the Share icon in the top right</li>
        <li>Scroll and choose <em>Add to Home Screen</em></li>
        <li>Tap <em>Add</em></li>
      </ol>
      <p class="install-help__tips">If you do not see this option, open the app in Safari and use the same steps</p>
    </div>

    <div class="install-help__box" id="android-chrome" hidden>
      <h4>Android using Chrome</h4>
      <ol class="install-help__steps">
        <li>Tap the three dot menu in the top right</li>
        <li>Choose <em>Install app</em> or <em>Add to Home screen</em></li>
        <li>Confirm <em>Install</em></li>
      </ol>
      <p class="install-help__tips">You may also see an <em>Install</em> button in the address bar</p>
    </div>

    <div class="install-help__box" id="android-samsung" hidden>
      <h4>Android using Samsung Internet</h4>
      <ol class="install-help__steps">
        <li>Tap the menu button</li>
        <li>Select <em>Add page to</em> then <em>Home screen</em></li>
        <li>Confirm</li>
      </ol>
    </div>

    <div class="install-help__box" id="other-browsers" hidden>
      <h4>Other browsers</h4>
      <p>Look in the browser menu for <em>Install</em> or <em>Add to Home Screen</em></p>
    </div>

    <p class="install-help__tips">Installing adds an icon to your home screen and makes it function just like an app</p>

    <button type="button" id="install-help-never" class="install-help__never">Don’t show this again</button>
  </div>
</details>

<script>
(function(){
  const root = document.getElementById('install-help');
  const panel = document.getElementById('install-help-panel');
  const closeBtn = root.querySelector('.install-help__close');

  // Dismiss logic persisted in localStorage
  const providedKey = root.getAttribute('data-dismiss-key');
  const key = (providedKey && providedKey.trim().length) ? providedKey : 'ph-install-help::' + location.pathname; // app-scoped fallback

  // Optional reset via URL query: add ?reset_install_tip=1 to show again
  try {
    if (new URLSearchParams(location.search).get('reset_install_tip') === '1') {
      localStorage.removeItem(key);
    }
  } catch(e) {}

  if(localStorage.getItem(key)==='1'){ root.classList.add('hidden'); return; }

  closeBtn.addEventListener('click', function(e){
    e.preventDefault(); e.stopPropagation();
    localStorage.setItem(key,'1');
    root.classList.add('hidden');
  });

  const neverBtn = document.getElementById('install-help-never');
  if(neverBtn){
    neverBtn.addEventListener('click', function(){
      localStorage.setItem(key,'1');
      root.classList.add('hidden');
    });
  }

  // Platform detection
  const ua = navigator.userAgent || '';
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isAndroid = /Android/i.test(ua);
  const isSamsung = /SamsungBrowser/i.test(ua);
  const isCriOS = /CriOS/i.test(ua); // Chrome on iOS
  const isFxiOS = /FxiOS/i.test(ua); // Firefox on iOS
  const isSafari = isIOS && /Safari/i.test(ua) && !isCriOS && !isFxiOS;
  const isChromeAndroid = isAndroid && /Chrome/i.test(ua) && !isSamsung;

  function show(id){ var el = document.getElementById(id); if(el) el.hidden = false; }

  if(isIOS && isSafari){ show('ios-safari'); }
  else if(isIOS && isCriOS){ show('ios-chrome'); }
  else if(isAndroid && isSamsung){ show('android-samsung'); }
  else if(isChromeAndroid){ show('android-chrome'); }
  else { show('other-browsers'); }

  // Update aria-expanded on toggle and swap label text
  const summary = root.querySelector('summary');
  const label = root.querySelector('.install-help__summary strong');
  const closedText = 'Tap here for a reminder of how to save this app to your home screen';
  const openText = 'Hide instructions';
  root.addEventListener('toggle', function(){
    const exp = root.open ? 'true' : 'false';
    const btn = root.querySelector('.install-help__summary');
    btn && btn.setAttribute('aria-expanded', exp);
    if(label){ label.textContent = root.open ? openText : closedText; }
  });
})();
</script>


  <!-- One-time courtesy reminder overlay -->
  <section id="courtesyOverlay" role="dialog" aria-labelledby="courtesyTitle" aria-modal="true">
    <div class="courtesy-card">
      <h2 id="courtesyTitle">Thanks for supporting this work</h2>
      <p>Please do not share this link.</p>

      <label class="courtesy-check">
        <input type="checkbox" id="courtesyAck" />
        <span>I understand — got it!</span>
      </label>

      <button id="courtesyContinue" disabled>Continue</button>
    </div>
  </section>

  <div class="container" id="appRoot">
    <header>
      <img src="plot-twist-logo.png" alt="Plot Twist logo" class="logo" />
    </header>

    <div class="instructions">
      <h2>Here's How to Play Plot Twist!</h2>
      <p>Work together to make up a silly, creative, imaginative story by taking turns every few sentences.</p>
      <h3>Tips for Taking Turns</h3>
      <ul>
        <li>Use a "story stick" — any item around the house like a toy or even a spoon. Whoever holds the story stick gets to speak, then passes it to the next person.</li>
        <li>Or try saying "Popcorn!" and pointing to whoever's turn it is next to "pop" the story over to them.</li>
        <li>If playing with more than two people, establish the order before you start playing.</li>
      </ul>
      <p>Whenever you need a little creative inspiration to move the story along or just want to shake things up,<br><br>
      say "PLOT TWIST!" and tap the button for an idea!<br><br>
      You can tap as many times as you want... but...<br><br>
      For a fun challenge, do your best to stick with whatever idea is given to you and find a creative way to work it into the story — even if it doesn't seem to make sense at first.<br><br>
      Happy storytelling!</p>
    </div>

    <section class="card" aria-labelledby="recHeading" style="margin-top:16px">
      <h2 id="recHeading">Record Your Story!</h2>
      <div class="out" id="recStatus" aria-live="polite">Ready to record. Your audio stays on your device.</div>
      <div class="btns" style="margin-top:10px">
        <button id="btnRecStart">Start recording</button>
        <button class="secondary" id="btnRecStop" disabled>Stop</button>
        <button class="secondary" id="btnRecPlay" disabled>Play</button>
        <button class="secondary" id="btnRecDownload" disabled>Download</button>
      </div>
      <p class="muted">Tap to allow microphone access. This stays on your device.</p>
      <audio id="player" controls style="width:100%; margin-top:10px; display:none"></audio>
    </section>

    <div class="grid">
      <section class="card" aria-labelledby="titleHeading">
        <h2 id="titleHeading">STORY TITLE...</h2>
        <div class="out" id="titleOut" aria-live="polite">Tap the button below to get a title</div>
        <div class="btns" style="margin-top:10px">
          <button id="btnTitle">GET A TITLE!</button>
          <button class="secondary" id="btnTitleBack">Back</button>
          <button class="secondary" id="btnTitleFwd">Forward</button>
          <button class="secondary" id="btnReset">Reset</button>
        </div>
        <p class="muted">Here's a title suggestion to inspire the beginning of your story. Need a way to start? Try "Once Upon a Time..." or "Long ago and far away, there lived a..." — you can’t go wrong with the classics.</p>
      </section>

      <section class="card" aria-labelledby="twistHeading">
        <h2 id="twistHeading">READY FOR A PLOT TWIST..?</h2>
        <div class="out" id="twistOut" aria-live="polite">Tap the button below for a new idea</div>
        <div class="btns" style="margin-top:10px">
          <button id="btnTwist">PLOT TWIST!</button>
          <button class="secondary" id="btnTwistBack">Back</button>
          <button class="secondary" id="btnTwistFwd">Forward</button>
        </div>
        <p class="muted">Tap the Plot Twist button any time you want some inspiration!</p>
      </section>

      <section class="card" aria-labelledby="wrapHeading">
        <h2 id="wrapHeading">READY TO WRAP IT UP...?</h2>
        <div class="out" id="wrapOut" aria-live="polite">Tap the button below for a tip on how to end your story</div>
        <div class="btns" style="margin-top:10px">
          <button class="secondary" id="btnWrap">IDEAS FOR HOW TO END...</button>
          <button class="secondary" id="btnWrapBack">Back</button>
          <button class="secondary" id="btnWrapFwd">Forward</button>
        </div>
        <p class="muted">Need a little nudge for how to wrap up? Tap for a general idea and find a way to end the story together!</p>
      </section>
    </div>
  </div>

  <footer>
    © 2025 Mia Wisinski, Playful Heart Parenting. This app is for personal use only by those who have purchased access from Playful Heart Parenting. Please do not share this link publicly or distribute without explicit permission.
  </footer>

  <script>
/* ===================
   One-time courtesy reminder (unchanged)
=================== */
(function(){
  const COURTESY_KEY = 'plotTwist_courtesy_v1';
  const overlay = document.getElementById('courtesyOverlay');
  const ack     = document.getElementById('courtesyAck');
  const goBtn   = document.getElementById('courtesyContinue');

  if (localStorage.getItem(COURTESY_KEY) !== 'yes') {
    overlay.style.display = 'grid';
    ack.addEventListener('change', ()=>{ goBtn.disabled = !ack.checked; });
    goBtn.addEventListener('click', ()=>{
      localStorage.setItem(COURTESY_KEY, 'yes');
      overlay.classList.add('courtesy-hide');
      setTimeout(()=>{ overlay.style.display='none'; }, 320);
    });
  }
})();

/* ===================
   Prompt data (unchanged)
=================== */
const TITLES = [
  "The chipmunk who accidentally ate all the acorns in the forest",
  "The magical trash can",
  "Sally, the pig who wanted to be a singer",
  "Humphrey the invisible humpback whale",
  "The summer Henrietta discovered grilled cheese sandwiches",
  "The alligator’s mysterious trip to the dentist",
  "Darleen the dinosaur who couldn’t roar",
  "Two best friends and a time machine",
  "The little car who could only drive 5 miles per hour",
  "Thirteen ducks and a goose named Gary",
  "Wilbur the astronaut worm",
  "Gilbert the goat who couldn’t stop eating socks",
  "The giant who got the hiccups",
  "The magical talking pancake",
  "The day it rained ramen noodles",
  "Princess Penelope and the very stinky fart",
  "The day my pickle sandwich came to life",
  "The secret snack society",
  "The baby dragon who was scared of fire",
  "Thomas the turtle who started a rock band",
  "Gertrude the goose and her bad habit",
  "The magical couch",
  "Stanley the snail who wanted to go fast",
  "The legend of the purple cheeseburger",
  "The potato who wanted to have his own TV show",
  "The lost booger",
  "Lucinda the lion’s very fancy birthday party",
  "The chicken who was allergic to bawking",
  "The unicorn and octopus who became best friends",
  "The piece of cheese who tried to escape from the fridge",
  "Belinda the ballerina baboon",
  "The magical remote control",
  "The very confused penguin",
  "Grandma Gertie’s magical nose hair",
  "Tiny the T-Rex who opened a nail salon",
  "Robby the robot who fell in love",
  "The itsy bitsy spider’s big adventure to the zoo",
  "Mabel the mouse who wanted to get a pet donkey",
  "The mysterious lemonade stand",
  "The very silly cat sisters",
  "Bob and his cheese sculptures",
  "The day Dad turned into a donut",
  "Zeke the zebra who didn’t like his stripes",
  "The frog clown",
  "The disappearing gingerbread house",
  "The time machine powered by farts",
  "The very lazy mermaid",
  "The case of the stinky socks",
  "The hamster who could read people’s minds",
  "The very lonely elephant",
  "The shoes who wanted a day off",
  "The panda who ate too much bamboo",
  "The very rude pigeon",
  "The wizard who couldn’t stop burping",
  "The little chicken who never gave up",
  "Barrelda the pig who learned her manners",
  "The very confusing birthday party",
  "The case of the missing ice cream sandwiches",
  "Four squirrels and their sailboat",
  "The great big terrible fart",
  "The burp who wanted to make a friend",
  "The very silly cupcake baker",
  "The mystery of the disappearing library",
  "Geoffrey the giraffe who had a short neck",
  "Eggarina, the hard-boiled egg who wanted to be a pop star",
  "The blueberry who fell in love with a strawberry",
  "The fart heard ‘round the world",
  "The very shy pumpkin",
  "The very shy axolotl",
"The little tree frog who didn’t like to hop",
"The very loud pelican",
"Harold, the hungry hippo",
"Belinda the beaver’s trip to the dentist",
"The magic microwave",
"The magic mashed potatoes",
"The lost teddy bear",
"The nervous squirrel who wanted to be a star",
"The very stinky skunk who wanted a friend",
"The most epic game of hide-and-seek ever",
"Simon the cow who learned a lesson",
"The fart fairy",
"The apple tree that started growing oranges",
"The magic sailboat",
"The secret tambourine society",
"Carol, the kazoo-playing kangaroo",
"Rocky the rockstar rhino",
"The dryer that actually ate socks",
"Barbara the breakdancing Billy goat",
"The mysterious moldy cheese",
"The biggest fart in the history of the world",
"The cat who forgot how to meow",
"Henrietta the robot hen",
"Dave the disco dancing dinosaur",
"The mysterious magical wig",
"The very bored bunny",
"The firefly whose booty couldn’t light up",
"The tale never-ending spaghetti noodle",
"Sir Stinksalot, the very stinky knight",
"The very grumpy princess",
"The loudest burp in the history of the world",
"Freddy the frog and his pet cricket",
"Willy, the wonderful weird worm",
"Tabitha, the tabby cat who learned how to juggle",
"The adventures of Peggy the Pig",
"The wizard who lost his magic wand",
"The very loud snore",
"Snore-asaurus, the sleepy dinosaur",
"The barnyard talent show",
"The chameleon who couldn’t change colors",
"The mystery of the rotten egg",
"Henrietta and the case of the missing sneakers",
"Suzy the snoozy snail",
"The dog who forgot how to bark",
"Jane and the giant hard-boiled egg",
"Daphne and the very loud toad",
"The Mouse Queen",
"The Snail Prince",
"The Chipmunk King",
"The magical mischievous toothbrush",
"The legend of the stinkiest socks in the universe",
"Bartholomew the bumblebee who liked to brag",
"The very angry grasshopper",
"Minnie the spider and the web catastrophe",
"Griselda and the very annoying goat"
];

const TWISTS = [
  "Suddenly, a wizard appeared and said, “I’ll turn everyone into a pumpkin if you don’t do what I say!”",
  "Suddenly, a mysterious map floated down from the sky.",
  "Just then, a troll popped out and yelled, “I’m late!”",
  "Then, they heard a loud growl coming from around the corner…",
  "Suddenly, they noticed a tiny door… and it was open.",
  "Just then, a mysterious voice whispered, “There’s treasure hidden near you, all you have to do is follow these clues...”",
  "Just then, a nice old man wandered over and asked for a sandwich.",
  "Suddenly, they heard a loud, “BAWK!” and a giant chicken was heading straight toward them…",
  "Suddenly, they sneezed so big that they started lifting off the ground…!",
  "Just then, a weird stinky smell started to waft through the air and they immediately knew what it was…",
  "But nobody noticed the slippery banana peel lying right in front of them on the ground.",
  "Just then, they heard a loud bark and turned around to see a giant Great Dane drooling all over their stuff.",
  "Suddenly, a mysterious letter started floating down from the sky. It said…",
  "Just then, it started raining extremely hard, but it wasn’t normal rain…",
  "Something then caught their eye in the corner. It was a shiny gold coin…",
  "Suddenly, it started to smell like the yummiest waffles in the world.",
  "Just then, a loud boom could be heard throughout the land.",
  "Just then, the phone started ringing and a voice on the other line started trying to order some pizza.",
  "Suddenly, a dragon flew in and asked for directions to the dragon dance.",
  "Just then, a duck on a skateboard rolled past yelling, “NO TIME TO EXPLAIN, hop on!!”",
  "Just then, they heard a loud crash!",
  "It suddenly started to snow, to everyone’s surprise, so they all decided to…",
  "Nobody saw the little troll sneaking up behind them trying to steal all their snacks.",
  "Suddenly, a big large shadow appeared.",
  "Just then, a marching band burst in and played “Happy Birthday”—whose birthday was it?",
  "Before anyone even realized it, they looked down to see that their feet were dancing all by themselves!",
  "Then, out of the blue, a great owl swept down and said, “I have a warning for you…”",
  "Just then, there was a big “poof!” and out of a cloud of sprinkles and glitter, a fairy appeared…",
  "Suddenly, a loud fart, loud as thunder, rumbled through the land!",
  "Just then, the skies opened up and it started raining sprinkles!",
  "Just then, the skies opened up and it started raining pizza.",
  "Then, they could not believe their eyes… it started snowing, but it wasn’t snow. It was marshmallows!",
  "Just then, a little squeaky voice spoke up from the corner. It was a mouse who had been watching everything and had something to say…",
  "Suddenly, a little old lady named Griselda waddled in and yelled, “Who’s been stealing my petunias?!?”",
  "Just then, they heard a cackle and looked up to see a silly witch flying by on a broomstick… but when they looked closer it wasn’t actually a witch! It was a…",
  "“ROARRR!” roared a voice that startled everyone. It was the monster who lived in the next village over…",
  "Suddenly, music started blasting loudly out of nowhere. It was the song “John Jacob Jingleheimer Schmidt!” Everyone was very confused…",
  "Just then, a mysterious voice said, “I have the answer to all your problems. Just follow me!”",
  "Suddenly, a genie popped out and said, “Congratulations! You’ve just said the magic word and have now unlocked three wishes! What’s your first wish?!”",
  "Just then, an ice cream truck started driving by and everyone screamed…",
  "All of a sudden, the ground started to move beneath them… and they realized they had been standing on a giant this whole time!!",
  "Just then, they looked up to see a shooting star, but not just any shooting star. This one was extra sparkly and bright. They decided to make a wish…",
  "Suddenly, a giant grumpy toad bounced into the room and croaked, “Follow me if you know what’s good for ya!”",
  "Just then, a voice came from a nearby peanut butter jar whimpering, “Let me out!! I’ve been trapped for days…”",
  "Suddenly, the lights flickered… and out of nowhere appeared a magician! “Welcome to my show!” he cheered…",
  "Just then, a chihuahua wearing a tiny tuxedo burst through the door barking wildly.",
  "Suddenly, a gust of wind blew open the window, and a swarm of butterflies flew in.",
  "Just then, they realized something… They were all shrinking. Either that… or everything around them was growing bigger and bigger…",
  "Just then, a mysterious stranger walked over and offered them a rubber chicken, saying, “You look like you needed this…”",
  "“Meowww,” said the cat that was suddenly walking around from the corner. “Got any cat food? I’m hungry!”",
  "Suddenly, the ceiling began to shake and they realized there were 20 big raccoons jumping on the roof!",
  "Just then, a little robot zoomed in and beeped, “Greetings. I am Zog two point oh. At your service!”",
  "Just then, a tiny kazoo sound echoed through the air… who was playing it?",
  "Suddenly, a taxi cab pulled up and said, “Did somebody call for a ride?”",
  "Just then, they noticed a mysterious box in the corner that began shaking… and growling!",
  "Suddenly, the sky turned bright pink and it started raining candy.",
  "Just then, they tripped over a shoe that someone had left lying in the middle of the floor…",
  "Suddenly, a bubble appeared and started floating toward them, getting bigger and bigger until suddenly…",
  "Just then, someone shouted, “Oh my goodness, it’s Queen Dingledongle!” And sure enough, when they turned around, the Queen herself was approaching them.",
  "Suddenly, a gold, shimmery circle appeared in the middle of the air. It was a portal to another world!",
  "Just then, the ground beneath them rumbled and they realized that a nearby volcano was about to erupt!",
  "Just then, they looked up and noticed that all the clouds in the sky were mysteriously shaped like beagles. “What could it mean??” they wondered…",
  "Just then, the door creaked open and revealed… a very tall, very grumpy lady named Barthalia.",
  "“Hey!” shouted a voice out of the blue, “This would be the perfect spot to open up my new theme park!”",
  "Just then, a slowww parade of snails began slithering by… complete with a tiny snail marching band, tiny flags, and tiny snail floats.",
  "Suddenly, they heard a voice yelling, “Charge!” and looked up to see a great big angry donkey running straight toward them.",
  "Just then, a whistle blew from behind them. “That’s enough of that!” said the football coach who they hadn’t realized was there. “It’s time to play some football!”",
  "Suddenly, a loud voice shrieked, “Get back here, Matilda!!” and they turned to see a farmer chasing his cow Matilda, who was running away.",
  "Suddenly, a voice yelled, “LOOK OUT BELOW!!” and they looked up to see a funny-looking little man wearing goggles in a parachute floating down from the sky right above them.",
  "Suddenly, a loud grumbling sound started getting louder and louder… it sounded like a hungry tummy…",
  "Just then, a very strange smell started wafting through the air. It smelled like rotten eggs…",
  "Just then, a delicious smell started filling the air… it smelled like someone was baking pie!",
  "Suddenly, confetti started pouring down and a small crowd of people popped out yelling, “Surprise!!”",
  "All of a sudden, a faint crying sound was coming from nearby…",
  "Just then, a wandering moose appeared, looking lost and confused.",
  "Just then, a gust of glitter blew through the air and the sound of a tiny, mischievous laugh became louder and louder…",
  "Suddenly, a loud honk echoed through the air, and a very rude goose waddled over.",
  "Just then, it began raining purple… “Wait a second… is that grape juice??” they said.",
  "Suddenly, they heard the sound of a kazoo… getting louder… and louder…",
  "Just then, all the clocks started spinning backwards and they realized they were somehow traveling back in time.",
  "Suddenly, a sweet little old lady rode up on a scooter yelling, “The muffins are ready! Who wants one?!”",
  "Just then, they got a strange feeling that something stinky was about to happen…",
  "“Whoa, do I know you? You look so familiar!!” said a friendly voice out of nowhere.",
  "Suddenly, a thunderous BURP erupted… it was the loudest burp anyone has ever heard…",
  "Suddenly, there was this funny feeling that someone was watching… sure enough there was a wise old wizard standing nearby and he clearly had something important to say.",
"Just then, a loud “BOING! BOING!” sound grew louder and louder and a silly looking old lady on a pogo stick was bouncing closer to them, yelling, “Help! I don’t know how to stop this thing!!”",
"Just then a pterodactyl flew overhead calling out, “I just escaped from a time machine! What year is it!?!”",
"Suddenly the skies darkened as 1 million pigeons were flying overhead and heading straight towards them",
"Just then, a minty fresh breeze swept through and they turned to see a llama chewing gum, just standing there staring at them",
"Just then a teeny tiny voice said, “Help! Help me!!” and they looked down to see a ladybug who had rolled onto her back and couldn’t get up",
"“RAWWWR” roared a voice from out of nowhere… it was a grumpy lion who was testing out his roar to see if he could scare anyone.",
"What nobody realized was that there was a news crew filming all of this and they were live on television!",
"Suddenly a very, very stinky smell wafted over and they knew instantly what it was. The next door neighbor had left her moldy cheese out in the driveway again!",
"Just then it started to get hot… very, very hot! What was going on?",
"Suddenly — SPLASH! A big splash of water came crashing down onto them and they saw a mischievous gnome standing there with a bucket, giggling to himself.",
"“Hey!” called out a voice out of nowhere, “Are you looking for the solution to all your problems? Well look no further! I’m going door-to-door selling this magical potion that will solve all your problems no matter what they are!” It was a strange travelling salesman…",
"Suddenly, the ground started to rumble… and up popped a mole wearing sunglasses and holding a map. He said, “Anyone know how to get to the beach? I’ve been lost for weeks!!”",
"Just then, a nearby family of frogs who was having a picnic called out, “Hey! Wanna join us? We have plenty of fried flies for everyone!!”",
"Suddenly, a mysterious door appeared out of thin air, and out stepped a marching band playing, “Do Your Ears Hang Low”",
"Just then, a voice shouted, 'Incoming!' and they started being bombarded with water balloons from the mischievous next door neighbors",
"Suddenly a unicorn galloped over and said, “You look like you could use my help!”",
"Just then, the clouds parted and a fairy floated down from the sky, waving her magic wand and chuckling to herself.",
"Suddenly, they heard a sad voice cry, “Aww shucks, not AGAIN!!” and they turned to see a weary magician pulling a live octopus out of his hat.",
"Just then a nearby voice mumbled, “Oh fiddlesticks, I dropped my beans again…!”",
"“Boooohooooo!!” cried a voice out of nowhere… it was an elephant who had stepped on a thumb tack!",
"Just then, a giant sneeze echoed through the air… and a dragon appeared holding a giant box of tissues. “Are your allergies acting up too?!” she asked them…",
"Suddenly, there was thunderous applause coming from around the corner… there was a traveling circus show happening and everyone in town had come to watch.",
"Just then, a pizza delivery man arrived holding 45 boxes of pizza and said, “Is this your order?”",
"Suddenly everyone started floating slowly up off the ground…! “Holy Cannoli!” cried a voice… “It works! My anti-gravity machine works!!!”",
"Suddenly, a friendly clown popped out holding a bunch of balloons and said, “Surprise! I’ve been sent to wish you a happy birthday!”",
"Just then, a grumpy old fisherman walked by, muttering to himself, “I’m gonna catch some fish today if it’s the last thing I do!”",
"Suddenly, a very excited young man rushed over and said, “I know this sounds wild, but I’m a talent scout and I’m gonna make you a star!”",
"“HONK HONK!” honked a horn as a school bus pulled up… with a bunch of honking geese inside. “We’re with the school of geese,” said the driver. “Are we in the right place for the field trip?”",
"Suddenly, a rainbow shimmered in the distance… and a little laugh grew louder and louder, followed by a voice saying, “They’ll never find my gold… never!!!”",
"Just then, the sound of tap-dancing grew louder until a group of penguins shuffled over begging for someone to watch their new two dance show",
"Just then, a cow floated by holding a bunch of balloons and shouted, “I regret nothing!”",
"Suddenly, a wizard appeared but immediately sneezed and turned himself into a potato. “Oh, not again!” said the wizard-potato. Can someone grab my magic wand and help me…??”",
"Just then a voice called out, “Has anyone seen my keys??” and a frazzled bus driver ran over to them.",
"Just then, a turtle on roller skates zoomed past and said, “Finally! I’m the fastest turtle who ever lived! Who dares to race me??”",
"Just then, a tiny fairy appeared holding a clipboard and said, “Well hello, I’m the problem-solving fairy! Looks like you’re next on my list! What problem can I solve for you today?”",
"Just then a mysterious shadow appeared and when they looked up there was a spaceship hovering over the ground!",
"Suddenly a voice yelled out, “Stop that monkey!!” and little old man was chasing after a monkey who was heading straight towards them…",
"Nobody realized that it had started to rain and all the sandwiches that had been left out from lunch were getting soggy.",
"Suddenly, a knight in rusty armor stumbled in and said, “I’m Sir Fartsalot, and I’m here to save the day!!”",
"Just then, a boy in a superhero costume ran over and said, “Never fear! Superboy is here!”",
"Just then they noticed a plane was writing something in the sky… it was something that started with the letter O… but they couldn’t quite tell what it said…",
"“Ribbit! Ribbit!” Said a voice and they looked over expecting to see a frog but it was actually a very confused dog…",
"Just then, a spaceship landed… and a chicken wearing a crown waddled out. “Take me to your leader,” it clucked.",
"Suddenly, a giant disco ball dropped from the sky, and loud disco music started playing out of nowhere.",
"Just then the sound of a marching band filled the air and they realized they’d forgotten all about the big parade happening in the neighborhood that day!",
"Suddenly, the smell of fresh-baked cinnamon buns filled the air and everyone started drooling",
"“Excuse me, coming through!!” said a voice from out of the blue and a big flustered moose was making her way over",
"Just then a funny looking grandpa who was wearing underwear on his head hobbled over and said, “You there! Have you seen my cat Mr. Whiskers?”"
];

const WRAP_HINTS = [
  "End the story with something happy",
  "Finish by solving the main problem",
  "Have the characters feel safe again",
  "Let everyone get what they were hoping for",
  "Show how things have changed since the beginning",
  "End with the characters making a plan for next time",
  "Wrap it up with a feeling — excitement, relief, joy, or calm",
  "Leave the story open so it could continue later",
  "End in the same place or situation where it began",
  "Give the final line to the main character"
];

/* ===================
   DOM refs (unchanged ids except added Back/Forward)
=================== */
const titleOut=document.getElementById('titleOut');
const twistOut=document.getElementById('twistOut');
const wrapOut=document.getElementById('wrapOut');

const btnTitle=document.getElementById('btnTitle');
const btnTitleBack=document.getElementById('btnTitleBack');
const btnTitleFwd=document.getElementById('btnTitleFwd');
const btnReset=document.getElementById('btnReset');

const btnTwist=document.getElementById('btnTwist');
const btnTwistBack=document.getElementById('btnTwistBack');
const btnTwistFwd=document.getElementById('btnTwistFwd');

const btnWrap=document.getElementById('btnWrap');
const btnWrapBack=document.getElementById('btnWrapBack');
const btnWrapFwd=document.getElementById('btnWrapFwd');

/* Recorder refs (unchanged) */
const recStart=document.getElementById('btnRecStart');
const recStop=document.getElementById('btnRecStop');
const recPlay=document.getElementById('btnRecPlay');
const recDl=document.getElementById('btnRecDownload');
const recStatus=document.getElementById('recStatus');
const player=document.getElementById('player');

/* ===================
   Deck with history + persistent state
=================== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

function makeDeck(ns, items){
  const K = s => `${ns}_${s}`;
  const KEY_VER=K('ver'), KEY_ORDER=K('ord'), KEY_IDX=K('idx'), KEY_HIST=K('hist'), KEY_POS=K('pos');
  const version = String(items.length); // bump automatically if list length changes

  function freshOrder(avoid){
    const order = shuffle(Array.from({length:items.length},(_,i)=>i));
    if (avoid!=null && items.length>1 && order[0]===avoid){
      const k = 1 + Math.floor(Math.random()*(order.length-1));
      [order[0],order[k]]=[order[k],order[0]];
    }
    return order;
  }

  function save(s){
    localStorage.setItem(KEY_VER, version);
    localStorage.setItem(KEY_ORDER, JSON.stringify(s.order));
    localStorage.setItem(KEY_IDX, String(s.idx));
    localStorage.setItem(KEY_HIST, JSON.stringify(s.history));
    localStorage.setItem(KEY_POS, String(s.pos));
  }
  function load(){
    let s = { order:null, idx:0, history:[], pos:0 };
    if (localStorage.getItem(KEY_VER) === version){
      try{
        s.order = JSON.parse(localStorage.getItem(KEY_ORDER) || 'null');
        s.idx   = parseInt(localStorage.getItem(KEY_IDX) || '0',10) || 0;
        s.history = JSON.parse(localStorage.getItem(KEY_HIST) || '[]');
        s.pos   = parseInt(localStorage.getItem(KEY_POS) || '0',10) || 0;
      }catch{}
    }
    if (!Array.isArray(s.order) || s.order.length !== items.length){
      s.order=freshOrder(null); s.idx=0; s.history=[]; s.pos=0;
    } else {
      s.idx = Math.min(Math.max(0,s.idx), Math.max(0, s.order.length-1));
      s.pos = Math.min(Math.max(0,s.pos), s.history.length);
      s.history=s.history.filter(n=>Number.isInteger(n)&&n>=0&&n<items.length);
    }
    save(s); return s;
  }

  let S = load();

  function current(){
    if (!S.history.length || S.pos===0) return null;
    return S.pos===S.history.length ? S.history[S.history.length-1] : S.history[S.pos-1];
  }
  function canBack(){ return S.pos>1; }
  function canFwd(){ return S.pos<S.history.length; }

  function next(){
    if (S.pos < S.history.length) S.history.splice(S.pos); // clear forward history
    let {order, idx} = S;
    const pick = order[idx];
    idx++;
    if (idx>=order.length){ const avoid=pick; order=freshOrder(avoid); idx=0; }
    S.order=order; S.idx=idx; S.history.push(pick);
    if (S.history.length>500) S.history.shift();
    S.pos=S.history.length; save(S);
    return pick;
  }
  function back(){ if (!canBack()) return null; S.pos-=1; save(S); return S.history[S.pos-1]; }
  function fwd(){ if (!canFwd()) return null; const i=S.history[S.pos]; S.pos+=1; save(S); return i; }
  function reset(){ S={ order:freshOrder(current()), idx:0, history:[], pos:0 }; save(S); }

  return { items, next, back, fwd, current, canBack, canFwd, reset };
}

/* Build decks */
const deckTitle = makeDeck('pt_title', TITLES);
const deckTwist = makeDeck('pt_twist', TWISTS);
const deckWrap  = makeDeck('pt_wrap',  WRAP_HINTS);

/* Render helpers */
function renderDeck(deck, outEl, backBtn, fwdBtn, emptyText){
  const i = deck.current();
  outEl.textContent = (i==null) ? emptyText : deck.items[i];
  backBtn.disabled = !deck.canBack();
  fwdBtn.disabled  = !deck.canFwd();
}

/* ===================
   Generators + wiring (kept original behaviors)
=================== */
function resetOutputs(){
  titleOut.textContent='Tap the button below to get a title';
  twistOut.textContent='Tap the button below for a new idea';
  wrapOut.textContent='Tap the button below for a tip on how to end your story';
}

/* Title */
btnTitle.addEventListener('click', ()=>{
  const i = deckTitle.next();
  titleOut.textContent = deckTitle.items[i];
  // Clear the other two prompts like your original flow did
  twistOut.textContent='Tap the button below for a new idea';
  wrapOut.textContent='Tap the button below for a tip on how to end your story';
  btnTitleBack.disabled = !deckTitle.canBack();
  btnTitleFwd.disabled  = !deckTitle.canFwd();
});
btnTitleBack.addEventListener('click', ()=>{
  const i = deckTitle.back(); if (i!=null){
    titleOut.textContent = deckTitle.items[i];
    btnTitleBack.disabled = !deckTitle.canBack();
    btnTitleFwd.disabled  = !deckTitle.canFwd();
  }
});
btnTitleFwd.addEventListener('click', ()=>{
  const i = deckTitle.fwd(); if (i!=null){
    titleOut.textContent = deckTitle.items[i];
    btnTitleBack.disabled = !deckTitle.canBack();
    btnTitleFwd.disabled  = !deckTitle.canFwd();
  }
});
btnReset.addEventListener('click', ()=>{ deckTitle.reset(); resetOutputs(); btnTitleBack.disabled=true; btnTitleFwd.disabled=true; });

/* Twist */
btnTwist.addEventListener('click', ()=>{
  const i = deckTwist.next();
  twistOut.textContent = deckTwist.items[i];
  btnTwistBack.disabled = !deckTwist.canBack();
  btnTwistFwd.disabled  = !deckTwist.canFwd();
});
btnTwistBack.addEventListener('click', ()=>{
  const i = deckTwist.back(); if (i!=null){
    twistOut.textContent = deckTwist.items[i];
    btnTwistBack.disabled = !deckTwist.canBack();
    btnTwistFwd.disabled  = !deckTwist.canFwd();
  }
});
btnTwistFwd.addEventListener('click', ()=>{
  const i = deckTwist.fwd(); if (i!=null){
    twistOut.textContent = deckTwist.items[i];
    btnTwistBack.disabled = !deckTwist.canBack();
    btnTwistFwd.disabled  = !deckTwist.canFwd();
  }
});

/* Wrap */
btnWrap.addEventListener('click', ()=>{
  const i = deckWrap.next();
  wrapOut.textContent = deckWrap.items[i];
  btnWrapBack.disabled = !deckWrap.canBack();
  btnWrapFwd.disabled  = !deckWrap.canFwd();
});
btnWrapBack.addEventListener('click', ()=>{
  const i = deckWrap.back(); if (i!=null){
    wrapOut.textContent = deckWrap.items[i];
    btnWrapBack.disabled = !deckWrap.canBack();
    btnWrapFwd.disabled  = !deckWrap.canFwd();
  }
});
btnWrapFwd.addEventListener('click', ()=>{
  const i = deckWrap.fwd(); if (i!=null){
    wrapOut.textContent = deckWrap.items[i];
    btnWrapBack.disabled = !deckWrap.canBack();
    btnWrapFwd.disabled  = !deckWrap.canFwd();
  }
});

/* On load: show last picks if any, update nav states */
renderDeck(deckTitle, titleOut, btnTitleBack, btnTitleFwd, 'Tap the button below to get a title');
renderDeck(deckTwist, twistOut, btnTwistBack, btnTwistFwd, 'Tap the button below for a new idea');
renderDeck(deckWrap , wrapOut , btnWrapBack , btnWrapFwd , 'Tap the button below for a tip on how to end your story');

/* ===================
   Recorder (unchanged core, with minor robustness)
=================== */
let mediaRecorder=null, mediaStream=null, chunks=[], lastBlobUrl=null;

function pickSupportedMime(){
  const list = [
    "audio/mp4;codecs=aac",
    "audio/mp4",
    "audio/webm;codecs=opus",
    "audio/webm"
  ];
  for (const t of list){
    if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) return t;
  }
  return "";
}
function extFromMime(m){
  const s=(m||"").toLowerCase();
  if (s.includes("mp4")) return "m4a";
  if (s.includes("webm")) return "webm";
  return "audio";
}

recStart.addEventListener('click', async ()=>{
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true }, video:false });
    const mime = pickSupportedMime();
    mediaRecorder = new MediaRecorder(mediaStream, mime ? { mimeType: mime } : undefined);
    chunks = [];

    mediaRecorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = () => {
      const type = mediaRecorder.mimeType || mime || "audio/webm";
      const blob = new Blob(chunks, { type });

      if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
      lastBlobUrl = URL.createObjectURL(blob);

      player.src = lastBlobUrl;
      player.style.display = 'block';
      recPlay.disabled = false;
      recDl.disabled = false;
      recStatus.textContent = 'Recording ready to play or download';

      if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }

      const ext = extFromMime(type);
      recDl.onclick = ()=>{
        const a=document.createElement('a');
        a.href = lastBlobUrl;
        a.download = `plot-twist-story.${ext}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      };
    };

    mediaRecorder.start();
    recStatus.textContent='Recording…';
    recStart.disabled=true;
    recStop.disabled=false;
    recPlay.disabled=true;
    recDl.disabled=true;
  }catch(err){
    recStatus.textContent='Microphone not available or permission denied.';
  }
});
recStop.addEventListener('click', ()=>{
  if(mediaRecorder && mediaRecorder.state!=='inactive'){ mediaRecorder.stop(); }
  recStart.disabled=false;
  recStop.disabled=true;
});
recPlay.addEventListener('click', ()=>{ if(player.src) player.play(); });
  </script>
</body>
</html>
